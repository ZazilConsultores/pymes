<?php
	$formulario = $this->formulario;
	$unidadDAO = new Inventario_DAO_Unidad;
	
	$productos = $this->productos;
	$busquedaProductoTerminado = $this->busquedaProductoTerminado;
	$productoDAO = new Sistema_DAO_Subparametro;
	$productosDAO = new Inventario_DAO_Producto;
	$productosB = $productosDAO->obtenerProductos();
	$subBebidas = $productoDAO->obtenerSubparametroBebida();
	$subAbarrotes = $productoDAO->obtenerSubparametroAbarrotes();
	$subCarnes = $productoDAO->obtenerSubparametroCarnes();
	$subFrutas = $productoDAO->obtenerSubparametroFrutas();
	$subLacteos = $productoDAO->obtenerSubparametroLacteos();
	$subLicores = $productoDAO->obtenerSubparametroLicores();
	$subPanaderia = $productoDAO->obtenerSubparametroPanaderia();
	$subPescados = $productoDAO->obtenerSubparametroPescadosyMa();
	$subSemillas = $productoDAO->obtenerSubparametroSemillas();
	$subVerduras = $productoDAO->obtenerSubparametroVerduras();
	$subDulces = $productoDAO->obtenerSubparametroDulceria();
	$subPTS = $productoDAO->obtenerPT();
?>
<?php echo $formulario ?> 	 	
<!--despliega los productos correspondientes a la cafeteria
<section class="row">
	<div class="panel panel-success">
		<div class="panel-heading">
			<h3 class="panel-title">
				Productos.
			</h3>
		</div>
		<div class="panel-body">
			<table class="table table-striped table-condensed">
				<thead>
					<tr>
						<th>Clave Producto</th>
						<th>Descripción</th>
					</tr>
				</thead>
				<tbody>
					<?php foreach ($productos as $producto) : ?>
					<tr>
						
						<td><?php echo $producto->claveProducto ?></td>
						<td><?php echo $producto->producto ?></td>
					</tr>
					<?php endforeach; ?>
				</tbody>
			</table>
		</div>
	</div>
</section>
-->
<section class="panel panel-success">
	<div class="panel-heading">
		<h3 class="panel-title">Crear Producto Terminado</h3>
	</div>
	<div class="panel-body">
		<table id="productoTerminado" class="table table-striped table-condensed">
			<thead>
				<th>Busca Producto Terminado:</th>
					<td>
						<select class="form-control" id="productoTerminado">
							<?php foreach ($subPTS as $subPT) : ?>
								<option value="<?php echo $subPT["idProducto"] ?>"><?php echo $subPT["producto"]; ?></option>
							<?php endforeach; ?>
						</select>
					</td>
					
			</thead>
			<tbody>
				<tr>
					<th>Seleccionar Bebida:
					<td>
						<select id="subBebida"  class="form-control">
							<option value="0">Seleccione Bebida</option>
								<?php foreach ($subBebidas as $subBebida) : ?>
								<option value="<?php echo $subBebida["idProducto"] ?>"><?php echo $subBebida["producto"]; ?></option>
								<?php endforeach; ?>
						</select>
					</td>
					<th>Seleccionar Abarrotes:
					<td>
						<select id="subAbarrotes" class="form-control">
							<option value="0">Seleccione Abarrote</option>
								<?php foreach ($subAbarrotes as $subAbarrote) : ?>
								<option value="<?php echo $subAbarrote["idProducto"] ?>"><?php echo $subAbarrote["producto"]; ?></option>
								<?php endforeach; ?>
						</select>
					</td>
				</tr>
				<tr>
					<th>Seleccionar Carne:
					<td>
						<select  class="form-control">
							<option value="0">Seleccione Carne</option>
								<?php foreach ($subCarnes as $subCarne) : ?>
								<option value="<?php echo $subCarne["idProducto"] ?>"><?php echo $subCarne["producto"]; ?></option>
								<?php endforeach; ?>
						</select>
					</td>
					
					<th>Seleccionar Fruta:
					<td>
						<select  class="form-control">
							<option value="0">Seleccione Fruta</option>
							<?php foreach ($subFrutas as $subFruta) : ?>
								<option value="<?php echo $subFruta["idProducto"] ?>"><?php echo $subFruta["producto"]; ?></option>
							<?php endforeach; ?>
						</select>
					</td>
				</tr>
				<tr>
					<th>Seleccionar Lacteo:
					<td>
						<select  class="form-control">
							<option value="0">Seleccione Lacteo</option>
								<?php foreach ($subLacteos as $subLacteo) : ?>
								<option value="<?php echo $subLacteo["idProducto"] ?>"><?php echo $subLacteo["producto"]; ?></option>
								<?php endforeach; ?>
						</select>
					</td>
					<th>Seleccionar Licor:
					<td>
						<select  class="form-control">
							<option value="0">Seleccione Licor</option>
								<?php foreach ($subLicores as $subLicor) : ?>
								<option value="<?php echo $subLicor["idProducto"] ?>"><?php echo $subLicor["producto"]; ?></option>
								<?php endforeach; ?>
						</select>
					</td>
				</tr>
				<tr>
					<th>Seleccionar Panederia:
					<td>
						<select  class="form-control">
							<option value="0">Seleccione Pan</option>
								<?php foreach ($subPanaderia as $subPan) : ?>
								<option value="<?php echo $subPan["idProducto"] ?>"><?php echo $subPan["producto"]; ?></option>
								<?php endforeach; ?>
						</select>
					</td>
					<th>Seleccionar Pescados y Mariscos:
					<td>
						<select  class="form-control">
							<option value="0">Seleccione Pescados y Mariscos</option>
								<?php foreach ($subPescados as $subPescado) : ?>
								<option value="<?php echo $subPescado["idProducto"] ?>"><?php echo $subPescado["producto"]; ?></option>
								<?php endforeach; ?>
						</select>
					</td>
				</tr>
				<tr>
					<th>Seleccionar Semilla:
					<td>
						<select  class="form-control">
							<option value="0">Seleccione Semilla</option>
								<?php foreach ($subSemillas as $subSemilla) : ?>
								<option value="<?php echo $subSemilla["idProducto"] ?>"><?php echo $subSemilla["producto"]; ?></option>
								<?php endforeach; ?>
						</select>
					</td>
					<th>Seleccionar Verdura:
					<td>
						<select id="subVerduras" class="form-control">
							<option value="0">Seleccione Verdura</option>
								<?php foreach ($subVerduras as $subVerdura) : ?>
									<option value="<?php echo $subVerdura["idProducto"] ?>"><?php echo $subVerdura["producto"]; ?></option>
								<?php endforeach; ?>
						</select>
					</td>
				</tr>
				<tr>
					<th>Seleccionar Dulce:
					<td>
						<select  class="form-control">
							<option value="0">Seleccione Dulce</option>
								<?php foreach ($subDulces as $subDulce) : ?>
								<option value="<?php echo $subDulce["idProducto"] ?>"><?php echo $subDulce["producto"]; ?></option>
								<?php endforeach; ?>
						</select>
					</td>
					<th>Seleccionar Producto terminado:
					<td>
						<select  class="form-control">
						</select>
					</td>
				</tr>
				<!--<td>
						<button id="btnQueryEncuesta" class="btn btn-info" >
							<span class="glyphicon glyphicon-search"></span> Buscar Producto Terminado
						</button>
					</td>
				</th>-->
				<br />	
				<tr></tr>
							
				<tr>
					<td>Clave Producto</td>
					<td>Nombre</td>
					<td>Cantidad</td>
					<td>Presentacion</td>
				</tr>
				<tr>
					<td><input id="idClaveProducto" class="form-control"></input></td>
					<td><input id="nombre" class="form-control"></input></td>
					<td><input id="cantidad" class="form-control"></input></td>
					<td><select id="presentacion" class="form-control">></select></td>
					<td>
						<button id="agregar" class="btn btn-success" type="submit" >
							<span class="glyphicon glyphicon-plus-sign"></span> Agregar
						</button>
					</td>
				</tr>
				<tr>
					<td></td>
					
				</tr>
			</tbody>
		</table>
	</div>
	<div></div>
</section>

<!--Tabla detalle ProductoTerminado-->
<section class="row">
	<div class="panel panel-info">
		<div class="panel-heading">
			<h4 class="panel-title">Detalle.</h4>
		</div>
		<table id="detalleProductoTer" class="table table-striped table-condensed">
			<thead>
				<th>Clave </th>
				<th>Producto</th>
				<th>Presentación</th>
				<th>Precio unitario</th>
				<th>Importe</th>
			</thead>
			<tbody>
			</tbody>
		</table>
	</div>
</section>
<script>
	$(document).ready(function() {
		//Select abarrotes y claveProducto
		$("table#productoTerminado").on("change","select[id^='subAbarrotes']", function (){
			var abarrote = $(this).val();
	   		//console.log(abarrote);
	   		var $urlProducto = window.location.origin + "/General/inventario/json/productos/idProducto/" + abarrote ;
	   		//console.log($urlProducto);
	   		$.ajax({
	   			url: $urlProducto,
	   			dataType: "json",
				success: function(data){
					//console.log($urlProducto);
					//console.dir(data);
					$("input#idClaveProducto").empty();
					$("input#nombre").empty();
					$.each(data, function(i,item){
						if(data[i].idProducto == abarrote){
							$("#idClaveProducto").attr("value",data[i].claveProducto);
							$("#nombre").attr("value",data[i].producto);
						}	
						
					});
					
				}
	   		});//Termina busca producto
	   		
	   		//Busca producto desde el select subAbarrotes
	   		var $url = window.location.origin + "/General/inventario/json/multiplos/idProducto/" + abarrote ;
			console.log($url);
			$.ajax({
				url: $url,
				dataType: "json",
				success: function(data){
					//console.log($url);
					//console.dir(data);
					$("select#presentacion").empty();
					$.each(data, function(i,item){
						if(data[i].idProducto == abarrote){
							$("select#presentacion").append($("<option></option>").attr("value",data[i].idUnidad).text(data[i].unidad));
						}	
						
					});
					
				}
				
			});
	   	
	   	});
	   	
	   	//Select bebidas y claveProducto
		$("table#productoTerminado").on("change","select[id^='subBebida']", function (){
			var bebida = $(this).val();
	   		//console.log(abarrote);
	   		//$("#idClaveProducto").val(abarrote);
	   		var $urlProducto = window.location.origin + "/General/inventario/json/productos/idProducto/" + bebida ;
	   		//console.log($urlProducto);
	   		$.ajax({
	   			url: $urlProducto,
	   			dataType: "json",
				success: function(data){
					//console.log($urlProducto);
					//console.dir(data);
					$("input#idClaveProducto").empty();
					$("input#nombre").empty();
					$.each(data, function(i,item){
						if(data[i].idProducto == bebida){
							$("#idClaveProducto").attr("value",data[i].claveProducto);
							$("#nombre").attr("value",data[i].producto);
						}	
						
					});
					
				}
	   		});
	   		
	   		//Busca producto desde el select subAbarrotes
	   		var $url = window.location.origin + "/General/inventario/json/multiplos/idProducto/" + bebida ;
			console.log($url);
			$.ajax({
				url: $url,
				dataType: "json",
				success: function(data){
					//console.log($url);
					//console.dir(data);
					$("select#presentacion").empty();
					$.each(data, function(i,item){
						if(data[i].idProducto == bebida){
							$("select#presentacion").append($("<option></option>").attr("value",data[i].idUnidad).text(data[i].unidad));
						}	
						
					});
					
				}
				
			});
	   	
	   	});
	   	
	   	//Select verdura y claveProducto
		$("table#productoTerminado").on("change","select[id^='subVerduras']", function (){
			var verdura = $(this).val();
	   		console.log(verdura);
	   		//$("#idClaveProducto").val(abarrote);
	   		var $urlProducto = window.location.origin + "/General/inventario/json/productos/idProducto/" + verdura ;
	   		//console.log($urlProducto);
	   		$.ajax({
	   			url: $urlProducto,
	   			dataType: "json",
				success: function(data){
					//console.log($urlProducto);
					//console.dir(data);
					$("input#idClaveProducto").empty();
					$("input#nombre").empty();
					$.each(data, function(i,item){
						if(data[i].idProducto == verdura){
							$("#idClaveProducto").attr("value",data[i].claveProducto);
							$("#nombre").attr("value",data[i].producto);
						}	
						
					});
					
				}
	   		});
	   		
	   		//Busca producto desde el select subAbarrotes
	   		var $url = window.location.origin + "/General/inventario/json/multiplos/idProducto/" + verdura ;
			console.log($url);
			$.ajax({
				url: $url,
				dataType: "json",
				success: function(data){
					//console.log($url);
					//console.dir(data);
					$("select#presentacion").empty();
					$.each(data, function(i,item){
						if(data[i].idProducto == verdura){
							$("select#presentacion").append($("<option></option>").attr("value",data[i].idUnidad).text(data[i].unidad));
						}	
						
					});
					
				}
				
			});
	   	
	   	});
	   	
 	   
 	   //Genera array para enviar datos al controller
 	   $("#agregar").on("click",function(){
 	   	var datos = [];
 	   	
 		var idProducto = $("select#productoTerminado").val();
 		var productoEnlazado = $("select#subVerduras").val();
 		if(productoEnlazado == 0){
 			console.log("El productoEnlazado no pertenece a subAbarrotes");
 		}
 		var cantidad = $("input#cantidad").val();
 		var descripcion = $("input#nombre").val();
 		var presentacion = $("select#presentacion").val();
 	
 		console.log("producto:"+idProducto);
 		console.log("productoEnl:"+productoEnlazado);
 		console.log("cantidad:"+cantidad);
 		console.log("presentacion:"+presentacion);
 		
 		datos.push(new Dato(idProducto, productoEnlazado, cantidad,descripcion, presentacion));
 		console.dir(datos);
 		
 		var myString = JSON.stringify(datos);
 		console.log(myString);
 		if ($("input#datos").val(myString)){}
 			
 	   });
 	   	   
 	   /*var myString = JSON.stringify(datos);
 	   if ($("input#datos").val(myString)){};*/
 	  
 	  function Dato(idProducto, productoEnlazado, cantidad, descripcion, presentacion) {
		  this.idProducto = idProducto;
		  this.productoEnlazado = productoEnlazado;
		  this.cantidad = cantidad;
		  this.descripcion = descripcion;
		  this.presentacion = presentacion;
	  }
	 
	  //Llena tabla del producto terminado correspondiente
	  $("table#productoTerminado").on("change","select[id^='productoTerminado']", function (){
	  	var idPt = $("select#productoTerminado").val();
		var urlPT = window.location.origin + "/General/inventario/json/productoterminado/productoTerminado/"+idPt;
		console.log("El producto terminado es:");
		console.log(urlPT);
		$.ajax({
			url: urlPT,
			dataType: "json",
			success: function(data){
				console.log(urlPT);
				console.dir(data);
				var tbody = $("table#detalleProductoTer").find('tbody');
				tbody.empty();
				var unidades = <?php echo Zend_Json::encode($unidadDAO->obtenerUnidades()); ?>;
				
				$.each(data, function(i,item){
					
					var importe = data[i].cantidad * data[i].costoUnitario;
					tbody.append($('<tr>').
					append($('<td>').append(data[i].productoEnlazado)).
					append($('<td>').append(data[i].productoEnlazado)).
					append($('<td>').append(data[i].presentacion)).
					append($('<td>').append(data[i].costoUnitario)).
					append($('<td>').append(importe))
					);
				});
			}
		});
		
	  });
	   	
	});
</script>