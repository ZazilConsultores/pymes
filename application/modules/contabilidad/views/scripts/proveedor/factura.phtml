<?php 
	echo $this->formulario;
	$facturasProveedorDAO = new Contabilidad_DAO_FacturaProveedor;
?>

<section class="row">
	<div class="panel panel-primary">
		<div class="panel-heading">
			<h3 class="panel-title">Agregar Productos para Factura Entrada.</h3>
		</div>
		
		<div class="panel-body">
			<button id="addRow" class="btn btn-success" >
				<span class="glyphicon glyphicon-plus" ></span> Nuevo
			</button>
			<a id="generarJsonArray" class="btn btn-primary" data-toggle="modal" data-target="#msgConfirm">
				<span class="glyphicon glyphicon-cog" ></span> Cargar
			</a>
			<a class="form-inline">
				<button id="editarIva" class="btn btn-warning">
					<span class="glyphicon glyphicon-pencil" ></span> Editar Iva
				</button>
				
				<input id="ivaPorcentaje" type="text" class="form-control" value="16" disabled="disabled">
			</a>		
				<table id="productos" class="table table-striped table-condensed">
					<thead>
						<tr>
							<th>Cantidad</th>
							<th>Clave Producto</th>
							<th>Seleccione Unidad</th>
							<th>Codigo de Barras</th>
							<th>Descripcion</th>
							<th>Precio Unitario</th>
							<th>Importe</th>
							<th>Eliminar</th>
						</tr>
					</thead>
					<tbody>
						  
					</tbody>
					<tfoot>
						<tr>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td><strong>Subtotal:</strong></td>
							<td><input id="subTotal" class="form-control" /></td>
						</tr>
						<tr>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td><strong>Descuento:</strong></td>
							<td><input id="descuento" class="form-control" value="0" /></td>
						</tr>
						<tr>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td><strong>Subtotal generado despues del descuento:</strong></td>
							<td><input id="descuentoGenerado" class="form-control" value="0" /></td>
						</tr>
						<tr>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td><strong>Iva:</strong></td>
							<td><input id="iva" class="form-control" /></td>
						</tr>
						<tr>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td><strong>Total:</strong></td>
							<td><input id="total" class="form-control" /></td>
						</tr>
					</tfoot>	
				</table>
				<table>
					<thead>
						
					</thead>
					<tbody>
						<tr>
							<td align="center" ><strong>IEPS</strong></td>
							<td align="center"><strong>ISH</strong></td></td>
							<td align="center"><strong>ISR</strong></td>
						</tr>
						 <tr>
            				<td align="left"><input type="text" id="ieps" name="iEPS" size="15" class="form-control" value="0"></td>
          				 	<td align="left"><input type="text" id="ish" name="ish" size="15" class="form-control" value="0"></td>
          				 	<td align="left"><input type="text" id="isr" name="isr" size="15" class="form-control" value="0"></td>	
          				 </tr>
          				 <tr>
            				
          				 </tr>
          				 <tr>
            				
          				 </tr>
					</tbody>
					<tfoot>
						
						
					</tfoot>
					
				</table>
		</div>
	</div>
</section>	

<script>
$(document).ready(function () {
	console.log( "ready!" );
		var jsonProductos = <?php echo $this->jsonProductos; ?>;
		var jsonUnidad = <?php echo $this->jsonUnidad; ?>;
		//var jsonImpuestos = <?php echo $this->jsonImpuestos; ?>;
		
		//console.dir(jsonImpuestos);
		
    var filasTabla = 1;
    $("#addRow").on("click", function () {
        /*filasTabla ++;
        //var inputCantidad = $('<input />').attr({'id': 'idCantidad_' + filasTabla}).attr({'class':'form-control'}).attr({'required':"La cantidad no puede quedar vacia"});
        var newRow = $("<tr>");
        var cols = "";
        cols +=  var inputCantidad = $('<input />').attr({'id': 'idCantidad_' + filasTabla}).attr({'class':'form-control'}).attr({'required':"La cantidad no puede quedar vacia"});
        cols += '<td>$<input  name="price' + fila + '"/></td>';
        cols += '<td><input  name="qty' + fila + '"/></td>';
        cols += '<td>$<input name="linetotal' + fila + '" readonly="readonly"/></td>';
        cols += '<td><a class="deleteRow"> x </a></td>';
        newRow.append(cols);*/
       var newRow = $("<tr>");
       var inputCantidad = $('<input />').attr({'id': 'idCantidad_' + filasTabla}).attr({'class':'form-control'}).attr({'required':"La cantidad no puede quedar vacia"});
			// idProducto
			var inputProducto = $('<input />').attr({'id': 'idProducto_' + filasTabla}).attr({'class':'form-control'});

			// idUnidad
			var inputUnidad = $('<select />').attr({'id': 'idUnidad_' + filasTabla}).attr({'class':'form-control'});
			$.each(jsonUnidad,function(i,item){
				inputUnidad.append('<option value="'+jsonUnidad[i].idUnidad+'">'+jsonUnidad[i].unidad+'</option>');
			});
			// codigoBarras
			var inputCodigoBarras = $('<input />').attr({'id': '0' + filasTabla}).attr({'class':'form-control'});
			// descripcion
			//var inputdescripcion = $('<input />').attr({'id': 'descripcion_' + filasTabla}).attr({'class':'form-control'});
			var selectdescripcion = $('<select />').attr({'id': 'descripcion_' + filasTabla}).attr({'class':'form-control'});
			$.each(jsonProductos,function(i,item){
				selectdescripcion.append('<option value="'+jsonProductos[i].idProducto+'">'+jsonProductos[i].producto+'</option>');
			});
			// precioUnitario
			var inputCostoUnitario = $('<input />').attr({'id': 'costoUnitario_' + filasTabla}).attr({'class':'form-control'});
			// precioImporte
			var inputCostoTotal = $('<input />').attr({'id': 'costoTotal_' + filasTabla}).attr({'class': 'costoTotal' + filasTabla}).attr({'class':'form-control'}).attr({'name':'costoTotal_'});
			
			// botonLimpiar
			var buttonLimpiar = $('<button />').attr({'id': 'btnLimpiar_' + filasTabla}).attr({'class':'btn btn-danger'});
			buttonLimpiar.html('<span class="glyphicon glyphicon-remove-circle"></span> Eliminar Producto')	;
      
        $("table#productos").append($('<tr>').
				append($('<td>').append(inputCantidad)).
				append($('<td>').append(inputProducto)).
				append($('<td>').append(inputUnidad)).
				append($('<td>').append(inputCodigoBarras)).
				append($('<td>').append(selectdescripcion)).
				append($('<td>').append(inputCostoUnitario)).
				append($('<td>').append(inputCostoTotal)).
				append($('<td>').append(buttonLimpiar))
				
			);
    });
    
    $("table#productos").on("change", 'input[id^="idCantidad_"], input[id^="costoUnitario_"]', function (event) {
        calculateRow($(this).closest("tr"));
        calculateGrandTotal();
        descuento();
    });
    
    $("table#productos").on("click", "a.deleteRow", function (event) {
        $(this).closest("tr").remove();
        calculateGrandTotal();
    });
});
    
function calculateRow(row) {
    var  precioUnitario= +row.find('input[id^="costoUnitario_"]').val();
    var cantidad = +row.find('input[id^="idCantidad_"]').val();
    row.find('input[id^="costoTotal_"]').val((cantidad * precioUnitario).toFixed(2));
}
    
function calculateGrandTotal() {
    var grandTotal = 0;
    
    $("table#productos").find('input[id^="costoTotal_"]').each(function () {
        grandTotal += +$(this).val();
       
    });
    $("#grandtotal").text(grandTotal.toFixed(2));
    $("#subTotal").val(grandTotal.toFixed(2));
    /*Descuento*/
     
    /*	 */
  }
  //Funcion Eliminar #btnLimpiar_2
 		$("table#productos").on("click", "button[id^='btnLimpiar_']", function(){
  			// si tenemos mas de una fila
  			if ($("table#productos tbody > tr").length >1)
  			{
  				$("table#productos  tbody > tr:last").remove();
  			}
  			
 		});//cierra funcion eliminar
 		
 $("select#idEmpresas").on('change', function(){
			var url = window.location.origin + "/General/public/sistema/json/sucursales/idFiscales/" + this.value;
			console.log(url);
			$.ajax({
				url: url,
				dataType: "json",
				success: function(data){
					console.dir(data);
					$("select#idSucursal").empty();
					$.each(data, function(i,item){	
						$("select#idSucursal").append($("<option></option>").attr("value",data[i].idSucursal).text(data[i].nombreSucursal)); 
					});
					
				}
			});
		});
		
$("select#idSucursal").on('click', function(){
				var url = window.location.origin + "/General/public/sistema/json/proyectos/idSucursal/" + this.value;
				console.log(url);
				$.ajax({
					url:url,
					dataType: "json",
					success: function(data){
						console.dir(data);
						$("select#idProyecto").empty();
						$.each(data, function(i,item){
							$("select#idProyecto").append($("<option></option>").attr("value",data[i].idProyecto).text(data[i].descripcion));
						});
					}
				});
		});
function descuento() {  
	var descuento = 0;
	var total = 0;	
	$("table#order-list ").keyup("input[id^='subtotal']", function(){
  	
    if($("#descuento").val()!== "0") {
    	console.log("El descuento es diferente de cero");
    	$("#descuentoGenerado").val(descuento);
    	descuento = parseFloat($("#subtotal").val()) - parseFloat( $("#descuento").val());
		//Realiza el total, cuando hay descuento
		total =  parseFloat( $("#descuentoGenerado").val(descuento));
    	console.log(total);
    }
    }); 
  
}

</script>